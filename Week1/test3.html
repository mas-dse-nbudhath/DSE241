<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/d3.min.js"></script>
    <script src="./js/jquery-3.2.1.min.js"></script>
    <script src="http://d3js.org/d3.v4.min.js"></script>
    <script src="./js/linq.js" type="text/javascript"></script>
<style>
    .fix-table-height{
      /* max-height:315px; */
      max-height: 455px;
    }   

</style>
<script>
    var data;
    var result;
    var defaultCountryValue = "Germany";

    function tabulate(data, columns) {
          var table = d3.select('#tbl1')
        //   table.attr("class","table table-striped table-hover");
        //   table.attr("style","height : 35px;")
          var thead = table.append('thead')
          var tbody = table.append('tbody');
          

          // append the header row
          thead.append('tr')
            .selectAll('th')
            .data(columns).enter()
            .append('th')
              .text(function (column) { return column; });

          // create a row for each object in the data
          var rows = tbody.selectAll('tr')
            .data(data)
            .enter()
            .append('tr')
            .on("click", function(elem) {
                console.log(elem);
              })            
            .attr("style","height : 5px; font-size: 80%;");

          // create a cell in each row for each column
          var cells = rows.selectAll('td')
            .data(function (row) {
              return columns.map(function (column) {
                return {column: column, value: row[column]};
              });
            })
            .enter()
            .append('td')
              .text(function (d) { return d.value; });


          return table;
      }    


    function generateTable(data) {
        var q = Enumerable.From(
        Enumerable.From(data)
        .Select(function (x) {
            if(x.Medal == 'Gold') {
                x.MedalValue = 1;
            }
            else if(x.Medal == 'Silver') {
                x.MedalValue = .5;
            }
            else {
                x.MedalValue = .25;
            }
            
            if(x.Country.indexOf('Germany') > -1) {
                x.Country = 'Germany';
            }
            
            return x;
        }) 
        )

        .GroupBy("{ country: $.Country, year: $.Year, medal: $.Medal }", 
                null,
                function (key, g) {
                    var result = {
                        country: key.country,
                        total: g.Sum("$.MedalValue")
                    }
                    return result;
                }, 
                function (x) { 
                    return x.country 
                })
        .Select(function(x) {
                return {
                    'Country' : x.country,
                    'Score': x.total
                };
            })
        .ToArray();

        result = Enumerable.From(q)
        .Where(function(x) { 
        return x.Country != 'Soviet Union';
        })
        .OrderByDescending("$.Score")
        // .Take(10)
        .ToArray();

        var result = result.map(function(r, i) {
            r.Rank = i + 1;
            console.log(r);
            return r;
        });

        var table = tabulate(result, ['Rank', 'Country', 'Score'])
    }


    function generateChart(data) {
            function getMedalCount(x) {
                function extend(obj, src) {
                        for (var key in src) {
                        if (src.hasOwnProperty(key)) obj[key] = src[key];
                    }
                    return obj;
                }

                var y = Enumerable.From(x)
                .GroupBy("{ year: $.Year }", 
                    null,
                    function (key, g) {
                        var result = {
                            year: key.year
                        }
                        return result;
                    }, 
                    function (yx) { 
                        return yx.year;
                    })
                .Select(function(yx) {
                    var a = Enumerable.From(x)
                        .Where(function(ax) {
                            return ax.Year == yx.year;
                        })
                        .Select(function(ax) {
                            var j = {};
                            j[ax.Medal] = ax.Total;
                                                
                            return j;
                        })
                        .ToArray();
                    
                    var m = {};
                    m.Year = yx.year;
                    m.Medals = a;
                    
                    c = {};
                    for(var idx in a) {
                        console.log(idx);
                        var obj = (a[idx]);
                        console.log(obj);
                        //Object.assign({}, obj, c);
                        extend(c, obj);
                    }
                    console.log(c);
                    
                        
                    return { Year : yx.year, Medals : c};
                })
                .ToArray();
                return y; 
        } 


        var svg = d3.select("#chart"),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        

        var x = d3.scaleBand()
            .rangeRound([0, width])
            .paddingInner(0.05)
            .align(0.1);

        var y = d3.scaleLinear()
            .rangeRound([height, 0]);

        var z = d3.scaleOrdinal()
            .range(["#FFDF00", "#c0c0c0", "#cd7f32"]);


        var medals = Enumerable.From(data)
                        .Where(function(x){ return x.Country==defaultCountryValue})

                        .GroupBy(null,null,"{Country:$.Country, Year:$.Year, Medal: $.Medal, Total: $$.Count() }",
                                            "'' + $.Year + '-' + $.Medal")
                        .OrderBy("$.Year","$.Medal")
                        
                        .ToArray();

        var md=getMedalCount(medals); 
        
        var d = md.map(function(d) {
            var gold = 0, silver=0, bronze=0;

            console.log(Object.keys(d.Medals).indexOf('Gold') > -1);

            if(Object.keys(d.Medals).indexOf('Gold') > -1) {
                gold = d.Medals.Gold;
            }

            if(Object.keys(d.Medals).indexOf('Silver') > -1) {
                silver = d.Medals.Silver;
            }
            
            if(Object.keys(d.Medals).indexOf('Bronze') > -1) {
                bronze = d.Medals.Bronze;
            }

            return {
                    Year: d.Year,
                    Gold: gold,
                    Silver: silver,
                    Bronze: bronze,
                    total: gold+silver+bronze
            };
        });            
            
           
    data=d; //d has now the structure wanted by data, easier to assign data as d instead of changing everywhere in code

    var keys = ['Gold','Silver','Bronze'];

    x.domain(data.map(function(d) { return d.Year; }));
    y.domain([0, d3.max(data, function(d) { return d.total; })]).nice();
    z.domain(keys);

    g.append("g")
    .selectAll("g")
    .data(d3.stack().keys(keys)(data))
    .enter().append("g")
      .attr("fill", function(d) { return z(d.key); })
    .selectAll("rect")
    .data(function(d) { return d; })
    .enter().append("rect")
      .attr("x", function(d) { return x(d.data.Year); })

      .attr("y", function(d) { return y(d[1]); })
      .attr("height", function(d) { return y(d[0]) - y(d[1]); })
      .attr("width", x.bandwidth());

    g.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
    .selectAll("text")
        .attr("y", 0)
        .attr("x", 8)
        .attr("dy", ".35em")
        .attr("transform", "rotate(90)")
        .style("text-anchor", "start");
      

    g.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(y).ticks(null, "s"))

    .append("text")
      .attr("x", 2)
      .attr("y", y(y.ticks().pop()) + 0.5)
      .attr("dy", "0.32em")
      .attr("fill", "#000")
      .attr("font-weight", "bold")
      .attr("text-anchor", "start")
      .text("Olympics Medals");

    var legend = g.append("g")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .attr("text-anchor", "end")
    .selectAll("g")
        .data(keys.slice().reverse())
        .enter().append("g")
        .attr("transform", function(d, i) { return "translate(-100," + i * 20 + ")"; });

    legend.append("rect")
      .attr("x", width - 19)
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", z);

    legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(function(d) { return d + ' ' + 'Medal'; });
        
    }    




    d3.json('data/exercise2-olympics.json', function (error,rawData) {
        data = rawData;
        generateTable(data);
        generateChart(data);
    });



</script>



<style>

.axis {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

</style>
</head>

<body>
         
<div class="container">
    <div class="row" style="width : 100%; background-color: white; height : 55px; border-bottom: 1px solid rgb(165, 161, 161); text-anchor:middle; margin-top: 10px;">
            <svg viewBox="-34 -12 68 33" width="102" height="49.5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <defs>
                   <clipPath id="interlace">
                      <path d="M -11,-11 h 22 v 22 h -22 z M 11,-1.5 a 10.5,10.5 0 0,0 0,21 v -3 a 7.5,7.5 0 1,1 0,-15 M -11,1.5 a 7.5,7.5 0 1,1 0,15 v 3 a 10.5,10.5 0 0,0 0,-21 z" clip-rule="evenodd"/>
                   </clipPath><clipPath id="interlace_Firefox"><!-- Firefox workaround -->
                      <path d="M 0,0 l -12,12 h 12 z"/> 
                   </clipPath>
                   <g id="ring">
                      <circle r="9"  clip-path="url(#interlace)"/>
                      <circle r="9"  clip-path="url(#interlace_Firefox)"/><!-- Firefox workaround -->
                      <path d="M 0,-9 a 9,9 0 0,1 9,9" transform="rotate(45)"/>
                   </g>
                </defs>
             
                <g fill="none" stroke-width="2">
                   <g stroke="#0085c7" transform="translate(-22,0)">
                      <use xlink:href="#ring"/>
                      <path d="M 0,-9 a 9,9 0 0,0 0,18"/>
                   </g>
                   <use xlink:href="#ring" stroke="black"/>
                   <g stroke="#df0024" transform="translate(22,0)">
                      <use xlink:href="#ring"/>
                      <path d="M 0,-9 a 9,9 0 0,1 0,18"/>
                   </g>
                   <use xlink:href="#ring" stroke="#f4c300" transform="translate(-11,9) rotate(180)"/>
                   <use xlink:href="#ring" stroke="#009f3d" transform="translate(11,9) rotate(180)"/>
                </g>
             </svg>
        <span style="font-family:Raley Script; background-color: none; text-align:center; text-anchor:middle; float:left; top:15px;"><h4>Winter Olympics World Ranking</h4></span><p>&nbsp;</p><span style="font-size: 75%">[based on 1928-2006 data]</span></div>
    <div class="row">
        <div class="col-md-4" style="margin-top: 5px;">
                <div class="table-responsive fix-table-height" style="background-color: none;">
                    <table id="tbl1" border="0" class="table table-sm table-inverse" style="cursor: pointer" ></table>
                </div>
        </div>
        <div class="col-md-8">
                <div id="thisone">
                        <div id="dd"></div>
                        <div>
                                <svg id="chart" width="600" height="500"></svg>
                        </div>        
                        <div id="res">xx</div>
                
                </div>
        </div>
    </div>
</div>

<img src="4x3/us.svg" style="width : 25px; height : 18.75px;">


</body>
</html>    